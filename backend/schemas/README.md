# Database Schema Snapshots

This directory contains auto-generated snapshots of the database schema.

## Files

### `current-schema.json`
Auto-generated snapshot of the current database structure.

**Generated by:**
```bash
npm run migrate       # After running migrations
npm run db:snapshot   # Manually generate/update
```

**Used by:**
- `scripts/audits/audit-db.js` - Database audit validation

**Format:**
```json
{
  "version": "1.0.0",
  "generated_at": "2025-10-21T...",
  "database_version": "PostgreSQL 17.5...",
  "schemas": {
    "tenants": {
      "tables": [
        {
          "name": "business",
          "columns": [...],
          "indexes": [...],
          "constraints": [...]
        }
      ]
    }
  }
}
```

## Why Auto-Generate?

**Problem:** Hardcoding expected schemas in audit scripts gets out of sync.

**Solution:** Generate schema snapshot from actual database after migrations.

**Benefits:**
- ✅ Always accurate (reflects actual DB state)
- ✅ No manual maintenance
- ✅ Fast (audit reads JSON instead of querying DB)
- ✅ Version controlled (can track schema changes)

## Usage

### Generate Snapshot
```bash
cd backend
npm run db:snapshot
```

### Run Migrations (Auto-Generates Snapshot)
```bash
cd backend
npm run migrate
```

### Audit Database (Uses Snapshot)
```bash
npm run audit:db
```

## Git Strategy

**Option 1: Commit It** (Recommended)
- Commit `current-schema.json` to track schema evolution
- See exactly what changed in each migration
- Useful for code reviews

**Option 2: Ignore It**
- Add to `.gitignore` if you want it local-only
- Each developer generates their own from their DB
- Lighter repo, but less visibility into changes

## Notes

- Snapshot is generated **after migrations run**, so it always reflects applied state
- If snapshot is missing, audit script uses minimal fallback validation
- Snapshot includes: tables, columns, indexes, constraints (full structure)

