# Backend Schemas

This directory contains all schema-related files for the backend, organized into manual and auto-generated sections.

## 📁 Directory Structure

```
backend/schemas/
  ├── validation/              ← MANUAL: Zod validation schemas
  │   ├── index.js             ← Main export (import from here)
  │   ├── common.js            ← Shared field validators
  │   ├── auth.schemas.js      ← Auth validation
  │   ├── tenants.schemas.js   ← Tenant validation
  │   ├── ...                  ← Other domain schemas
  │   └── README.md            ← Validation documentation
  │
  ├── generated/               ← AUTO-GENERATED: Don't edit!
  │   └── current-schema.json  ← Database structure snapshot
  │
  ├── apiSchemas.js            ← DEPRECATED: Backwards compatibility
  └── README.md                ← This file
```

## 🎯 Purpose

### `validation/` - Zod Validation Schemas (Manual)

**What:** Business rules and API input validation  
**Who maintains:** You (manually written)  
**Used by:** Backend routes to validate API requests

Example:
```javascript
import { tenantSchemas } from './schemas/validation/index.js';

// Validate API input
const validated = tenantSchemas.signup.parse(req.body);
```

---

### `generated/` - Database Snapshots (Auto-Generated)

**What:** JSON snapshot of current database structure  
**Who maintains:** Auto-generated by `npm run migrate`  
**Used by:** Type generator to create TypeScript interfaces

Example:
```json
{
  "schemas": {
    "tenants": {
      "tables": [
        {
          "name": "business",
          "columns": [...]
        }
      ]
    }
  }
}
```

---

### `apiSchemas.js` - Backwards Compatibility (Deprecated)

**What:** Re-exports from `validation/index.js`  
**Who maintains:** Kept for backwards compatibility  
**Status:** Will be removed once all imports updated

**Don't use in new code.** Import from `validation/` instead.

---

## 🔄 The Complete Flow

```
1. You write SQL migration
   backend/migrations/2025-10-26_add_field.sql
   ↓

2. Run migration
   npm run migrate
   ↓

3. Database updated
   PostgreSQL tables/columns modified
   ↓

4. Snapshot auto-generates
   backend/schemas/generated/current-schema.json
   ↓

5. TypeScript types auto-generate
   frontend/src/shared/types/generated/db.types.ts
   ↓

6. You update validation (if needed)
   backend/schemas/validation/[domain].schemas.js
```

## 📝 Quick Reference

### Import Validation Schemas

```javascript
// ✅ New way (preferred)
import { authSchemas, tenantSchemas } from './schemas/validation/index.js';

// ❌ Old way (deprecated)
import { authSchemas } from './schemas/apiSchemas.js';
```

### Check Database Structure

```javascript
// Read the snapshot
import snapshot from './schemas/generated/current-schema.json' assert { type: 'json' };

// See what tables/columns exist
console.log(snapshot.schemas.tenants.tables);
```

### Add New Validation

1. Choose domain file: `validation/[domain].schemas.js`
2. Add schema using Zod
3. Export from `validation/index.js`
4. Use in route handlers

---

## 🛡️ The Three Layers

| Layer | Location | Manual/Auto | Purpose |
|-------|----------|-------------|---------|
| **Database Structure** | PostgreSQL | Manual (via migrations) | What exists |
| **Validation Rules** | `validation/*.schemas.js` | Manual | What we accept |
| **TypeScript Types** | `frontend/src/shared/types/generated/` | Auto-generated | Type safety |

---

## 🔧 Maintenance

### When Adding a Column

```sql
-- 1. Write migration
ALTER TABLE tenants.business ADD COLUMN logo_url TEXT;
```

```bash
# 2. Run migration (auto-updates snapshot + types)
npm run migrate
```

```javascript
// 3. Add validation (if API accepts it)
// validation/tenants.schemas.js
export const tenantSchemas = {
  update: z.object({
    logo_url: z.string().url().optional()
  })
};
```

### When Removing a Column

```sql
-- 1. Write migration
ALTER TABLE tenants.business DROP COLUMN temp;
```

```bash
# 2. Run migration (auto-updates snapshot + types)
npm run migrate
```

```javascript
// 3. Remove from validation (if it was there)
// validation/tenants.schemas.js
export const tenantSchemas = {
  update: z.object({
    // Remove: temp: z.string()
  })
};
```

---

## 🧪 Future: Audit Tool

```bash
# Coming soon
npm run audit:zod

# Will check:
# - Zod schemas reference existing DB columns
# - Required DB fields have validation
# - Type mismatches between Zod and DB
# - Dead validation for non-existent columns
```

---

## 📚 Related Documentation

- **Validation schemas**: `validation/README.md`
- **Database migrations**: `../migrations/README.md`
- **Generated types**: `../../frontend/src/shared/types/generated/README.md`
- **Migration guide**: `../../frontend/src/shared/types/MIGRATION_GUIDE.md`

---

## 🎓 Architecture Decision

**Why separate `validation/` and `generated/`?**

1. **Clear separation**: Manual vs auto-generated files
2. **Safety**: Can't accidentally edit generated files
3. **Organization**: Mirrors database schema structure
4. **Scalability**: Easy to add new domains
5. **Maintainability**: Each file has single responsibility

**Why keep `apiSchemas.js`?**

Backwards compatibility while updating imports across the codebase. Will be removed once all routes import from `validation/`.

---

**Questions?** Check `validation/README.md` for detailed usage examples.
